% addtional packages for the book
%

%-------------- making an index ------------------------
\usepackage{imakeidx}
\makeindex

\usepackage{setspace}
\usepackage{ragged2e}

\usepackage{comment}

\excludecomment{invisible}
% for now - must be included later
%\excludecomment{bbox}
\usepackage{tcolorbox}
\tcbuselibrary{breakable}
\newcommand{\boxwidth}{1\linewidth}
\tcbset{width=\boxwidth}
\newenvironment{bbox}{\begin{figure}[t]\begin{tcolorbox}}{\end{tcolorbox}\captionsetup{labelformat=empty}\end{figure}}

\newenvironment{bboxfix}{\begin{tcolorbox}}{\end{tcolorbox}}

\newenvironment{indentforeword}{\setlength{\parindent}{15pt}}{}


% addtional packages for the book
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available

%\usepackage{longtable}
\usepackage{wrapfig}
\usepackage{float}
\usepackage{colortbl}
\usepackage{pdflscape}
%\usepackage{tabu}
% \usepackage{threeparttable}
% \usepackage{threeparttablex}
%\usepackage[normalem]{ulem}
%\usepackage{makecell}
\usepackage{xcolor}
\usepackage{placeins} % for FloatBarrier

% 
% for tables
%
\usepackage{csvsimple}
%\usepackage{tabulary}

%
% Workaround
%
\newcommand{\BeginKnitrBlock}[1]{}
\newcommand{\EndKnitrBlock}[1]{}

%
% Bibliography-related
% 

%%%%% bib
\usepackage{natbib}
\setcitestyle{round}

\usepackage[sectionbib,globalcitecopy]{bibunits}


\setlength{\bibsep}{0.0pt}
\setlength{\bibhang}{6pt}

\renewcommand{\bibpreamble}{\footnotesize} 
\let\oldputbib\putbib
\renewcommand{\putbib}{\FloatBarrier\clearpage\oldputbib}
 
% Change name of bibliography
\renewcommand{\bibname}{References in Chapter \thechapter}


%
% Chapter author tables
%
\newenvironment{authorlist}{\renewcommand{\arraystretch}{1}\begin{tabular}{l}}{\end{tabular}}

%
% Handle Unicode in a few cases
%
\DeclareUnicodeCharacter{03C4}{$\tau$}
\DeclareUnicodeCharacter{03BC}{$\mu$}
\DeclareUnicodeCharacter{03B5}{$\epsilon$}

% 
% This handles the euro
%
% WARNING: this might affect other font choices!
%
\usepackage{textcomp}
\usepackage{eurosym}
\let\texteuro\euro
\DeclareUnicodeCharacter{020AC}{\euro}

% % use upquote if available, for straight quotes in verbatim environments
%\IfFileExists{upquote.sty}{\usepackage{upquote}}{}

%
% ========================  set widths ======================
%
% These lines came from Pandoc

\usepackage{graphicx,grffile}
% \makeatletter
% \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
% \def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
% \makeatother
% \setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% set default figure placement to htbp
\makeatletter
\def\fps@figure{t}
\makeatother


%
%  Override figure width
%
\newcommand{\ourfigurewidth}{0.8\textwidth}
\setkeys{Gin}{width=\ourfigurewidth,keepaspectratio}

% 
% Default tablewidth for tables that require it
% i.e., using tabulary
\newcommand{\ourtablewidth}{1.0\textwidth}

%
% crop marks - do we need these?
%
%\usepackage[cam,letter,center]{crop}

% PARAMETERS
% Figure 1 in PCRI
\newcommand{\widthpcria}{0.6\textwidth}
% Figure 2 in PCRI
\newcommand{\widthpcrib}{\ourfigurewidth}
% Figure A1 in PCRI
\newcommand{\widthpcriaa}{\ourfigurewidth}
% Figure A2 in PCRI
\newcommand{\widthpcriab}{\ourfigurewidth}
% Figure A3 in PCRI
\newcommand{\widthpcriac}{\ourfigurewidth}





%
% to prevent hyphenation in certain sections
% Wrap this around chapter titles
% with \begin{nohyphens}
% \chapter{...}
% \end{nohyphens}

% https://tex.stackexchange.com/questions/91307/temporarily-suppress-hyphenation
\makeatletter
\@ifpackageloaded{babel}
  {\newenvironment{nohyphens}
     {\par\sloppy\exhyphenpenalty=\@M
      \@ifundefined{l@nohyphenation}
        {\language=\@cclv}
        {\hyphenrules{nohyphenation}}%
     }
     {\par
      \@ifundefined{l@nohyphenation}
        {}
        {\endhyphenrules}%
     }
  }
  {\newenvironment{nohyphens}
     {\par\sloppy\exhyphenpenalty=\@M
      \@ifundefined{l@nohyphenation}
        {\language=\@cclv}
        {\language=\l@nohyphenation}%
     }
     {\par}
  }
\makeatother

%
% Function to create titlefootnote based on the short tag
% Requires: nameref
\usepackage{nameref}
\makeatletter
\newcommand{\authorfootnote}[3]{%
% 1: authors (in cmos notation)
% 2: authors (in and notation)
% 3: the chapter reference
  \begingroup
  \def\@makefntext##1{\noindent ##1}%
  \renewcommand{\thefootnote}{}%
  \footnote{Copyright \copyright ~ #2. \newline 
  Cite as: #1. ``\nameref{#3}.'' In: \bookcitation{}}%
  \addtocounter{footnote}{-1}%
  \addtocounter{Hfootnote}{-1}%
  \endgroup
}
\makeatother

%
% this is needed for BeginKnitrBlock
%
%\let\BeginKnitrBlock\begin
%\let\EndKnitrBlock\end
